# Specifications Consultation Rule

## Overview

This rule ensures that AI assistants always consult relevant specifications before implementing or modifying features, and update specifications when code changes.

## Core Principle

**Specifications are the single source of truth.** Always check specs before implementation, and update specs when code changes.

## Workflow

### Before Implementation

1. **Check for existing spec**: Look for relevant specification in `docs/specs/`
   - Search for feature name or related keywords
   - Check if spec exists for the feature being implemented

2. **If spec exists**: Read and understand the specification
   - Review business requirements
   - Review technical requirements
   - Understand data models and flows
   - Note any constraints or edge cases

3. **If spec doesn't exist**: Create one first
   - Use `docs/specs/TEMPLATE.md` as a starting point
   - Document business and technical requirements
   - Create spec before implementing code

4. **Check related ADRs**: Review relevant Architecture Decision Records in `docs/adr/`
   - Understand architectural decisions
   - Follow established patterns
   - Note any constraints

### During Implementation

1. **Follow the spec**: Implement according to the specification
   - Use specified DTOs and data models
   - Follow documented flows
   - Respect constraints and requirements

2. **Reference the spec**: Add comments referencing the spec
   ```python
   # See docs/specs/thumbnail-generation-spec.md
   class GenerateThumbnailUseCase:
       ...
   ```

3. **Document deviations**: If implementation must deviate from spec:
   - Update the spec to reflect the change
   - Document why the deviation was necessary
   - Add a changelog entry in the spec

### After Implementation

1. **Update spec if needed**: If implementation details differ from spec:
   - Update the spec to match actual implementation
   - Document any deviations in the changelog
   - Ensure spec reflects reality

2. **Commit with reference**: Include spec reference in commit messages
   ```
   feat: implement thumbnail generation
   
   Implements thumbnail generation use case as specified in
   docs/specs/thumbnail-generation-spec.md
   ```

## Specification Locations

### Feature Specifications
- **Location**: `docs/specs/`
- **Naming**: `feature-name-spec.md`
- **Template**: `docs/specs/TEMPLATE.md`

### Architecture Decision Records
- **Location**: `docs/adr/`
- **Naming**: `NNNN-decision-name.md`
- **Template**: `docs/adr/TEMPLATE.md`

### Architecture Documentation
- **Location**: `docs/architecture/`
- **Files**: `overview.md`, `messaging.md`, `use-cases.md`

## Rules

### ✅ DO

- Always check for existing specs before implementing features
- Read and understand specs before coding
- Create specs for new features before implementation
- Follow specifications during implementation
- Update specs when code changes
- Reference specs in code comments
- Include spec references in commit messages
- Review related ADRs for architectural context

### ❌ DON'T

- Implement features without checking for specs
- Ignore existing specifications
- Deviate from specs without updating them
- Create specs after implementation (unless documenting existing code)
- Forget to update specs when requirements change

## Examples

### Example 1: New Feature

```python
# ✅ CORRECT - Check spec first, then implement
# 1. Check docs/specs/thumbnail-generation-spec.md
# 2. Read specification
# 3. Implement according to spec

# See docs/specs/thumbnail-generation-spec.md
class GenerateThumbnailUseCase:
    async def execute(self, command: GenerateThumbnailCommand) -> GenerateThumbnailResult:
        # Implementation follows spec
        ...
```

### Example 2: Updating Existing Feature

```python
# ✅ CORRECT - Update spec when changing behavior
# 1. Read docs/specs/thumbnail-generation-spec.md
# 2. Make code changes
# 3. Update spec to reflect changes
# 4. Document in spec changelog

# Updated per docs/specs/thumbnail-generation-spec.md (v2)
class GenerateThumbnailUseCase:
    async def execute(self, command: GenerateThumbnailCommand) -> GenerateThumbnailResult:
        # New implementation
        ...
```

### Example 3: Deviation from Spec

```python
# ✅ CORRECT - Document deviation
# 1. Read spec
# 2. Identify need to deviate
# 3. Update spec with deviation and reason
# 4. Implement with deviation documented

# Deviation from docs/specs/thumbnail-generation-spec.md:
# Using different image size due to API limitations (see spec changelog)
class GenerateThumbnailUseCase:
    async def execute(self, command: GenerateThumbnailCommand) -> GenerateThumbnailResult:
        # Implementation with documented deviation
        ...
```

## Checklist

Before implementing or modifying features:

- [ ] Checked for existing spec in `docs/specs/`
- [ ] Read and understood the specification
- [ ] Checked related ADRs in `docs/adr/`
- [ ] Created spec if it doesn't exist
- [ ] Implemented according to spec
- [ ] Added spec reference in code comments
- [ ] Updated spec if implementation deviates
- [ ] Included spec reference in commit message

## Related Documentation

- [Specifications Guide](../../docs/specs/README.md)
- [Specification Template](../../docs/specs/TEMPLATE.md)
- [ADR Guide](../../docs/adr/README.md)
- [Architecture Documentation](../../docs/architecture/README.md)
